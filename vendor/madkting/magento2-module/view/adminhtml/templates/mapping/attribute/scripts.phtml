<?php
/**
 * Madkting Software (http://www.madkting.com)
 *
 *                                      ..-+::moossso`:.
 *                                    -``         ``ynnh+.
 *                                 .d                 -mmn.
 *     .od/hs..sd/hm.   .:mdhn:.   yo                 `hmn. on     mo omosnomsso oo  .:ndhm:.   .:odhs:.
 *    :hs.h.shhy.d.mh: :do.hd.oh:  /h                `+nm+  dm   ys`  ````mo```` hn :ds.hd.yo: :oh.hd.dh:
 *    ys`   `od`   `h+ sh`    `do  .d`              `snm/`  +s hd`        hd     yy yo`    `sd oh`    ```
 *    hh     sh     +m hs      yy   y-            `+mno`    dkdm          +d     o+ no      ss ys    dosd
 *    y+     ss     oh hdsomsmnmy   ++          .smh/`      om ss.        dh     mn yo      oh sm      hy
 *    sh     ho     ys hs``````yy   .s       .+hh+`         ys   hs.      os     yh os      d+ od+.  ./m/
 *    od     od     od od      od   +y    .+so:`            od     od     od     od od      od  `syssys`
 *                                 .ys .::-`
 *                                o.+`
 *
 * @category Module
 * @package Madkting\Connect
 * @author Carlos Guillermo JimÃ©nez Salcedo <guillermo@madkting.com>
 * @link https://bitbucket.org/madkting/magento2
 * @copyright Copyright (c) 2017 Madkting Software.
 * @license See LICENSE.txt for license details.
 */

// @codingStandardsIgnoreFile
?>
<?php /** @var $block Madkting\Connect\Block\Adminhtml\AttributeMapping\Grid */ ?>
<script>
    require([
        'jquery',
        'Magento_Ui/js/modal/alert',
        'mage/translate'
    ], function ($, alert) {
        'use strict';

        $(function () {
            var gridWrapper = $('div.admin__data-grid-wrap');

            /* Show attribute set selector */
            $('div.attribute-set-selector-wrapper').show();

            /* Get grid by AJAX */
            function getAjaxGrid(attributeSetId) {
                $.ajax({
                    'url': '<?php echo $block->getUrl('*/attributemapping/ajaxgrid') ?>',
                    'data': {'attributeSetId':attributeSetId},
                    'dataType': 'json',
                    'showLoader': true
                }).done(function (data) {
                    if (data.error) {
                        alert({
                            'title': '<?php echo __('Error') ?>',
                            'content': data.message
                        });
                    } else {
                        gridWrapper.html(data.grid);
                    }
                });
            }

            /* Attribute set selector event */
            $('div.additional-options-header').on('change', '#madkting-attribute-set-select', function () {
                var attributeSetId = $(this).val();

                getAjaxGrid(attributeSetId);
            });

            /* Grid buttons action */
            $('div.page-main-actions')
                .on('click', '#new-attribute-mapping', function () {
                    var lastRow = $('#<?php echo $block->getGridName() ?>-table tr').last(),
                        rowClass = lastRow.hasClass('_odd-row') ? 'data-row' : 'data-row _odd-row',
                        attributeSet = $('#madkting-attribute-set-select').val(),
                        rowId = lastRow.attr('data-dynamic-Id') ? lastRow.data('dynamicId') + 1 : 1;

                    $.ajax({
                        'url': '<?php echo $block->getUrl('*/attributemapping/newrow') ?>',
                        'data': {'petition':'attributes', 'rowClass':rowClass, 'attributeSet':attributeSet, 'rowId':rowId},
                        'dataType': 'json',
                        'showLoader': true
                    }).done(function (data) {
                        if (data.error) {
                            alert({
                                'title': '<?php echo __('Error') ?>',
                                'content': data.message
                            });
                        } else {
                            $('#<?php echo $block->getGridName() ?>-table tbody').append(data.row);

                            $('html, body').animate(
                                {scrollTop: lastRow.offset().top},
                                1000,
                                "easeOutQuint"
                            );
                        }
                    });
                })
                .on('click', '#save-attribute-mapping', function () {
                    var attributeSetId = $('#madkting-attribute-set-select').val();

                    $.ajax({
                        'type': 'POST',
                        'url': '<?php echo $block->getFormAction() ?>',
                        'data': $('#<?php echo $block->getGridName() ?>-form').serialize() + '&attributeSetId=' + attributeSetId,
                        'dataType': 'json',
                        'showLoader': true
                    }).done(function (data) {
                        if (!data.error) {
                            getAjaxGrid(attributeSetId);
                        }

                        alert({
                            'title': data.title,
                            'content': data.message
                        });
                    });
                });

            /* Delete row action */
            gridWrapper.on('click', '#<?php echo $block->getGridName() ?>-table a.delete-action', function (e) {
                e.preventDefault();

                var self = $(this),
                    attributeName = self.parents('tr').find('span').text();

                alert({
                    'title': '<?php echo __('Delete') ?>' + ' ' + attributeName,
                    'content': '<?php echo __('Are you sure you want to delete') ?>' + ' <b>' + attributeName + '</b>?',
                    'buttons': [{
                        'text': '<?php echo __('No') ?>',
                        'class': 'action-secondary',
                        'click': function () {
                            this.closeModal(true);
                        }
                    },{
                        'text': '<?php echo __('Yes') ?>',
                        'class': 'action-primary',
                        'click': function () {
                            var modal = this,
                                attributeSetId = $('#madkting-attribute-set-select').val(),
                                attributeId = self.parents('tr').find('[id^="madkting"]').val();

                            $.ajax({
                                'type': 'POST',
                                'url': '<?php echo $block->getUrl('*/attributemapping/delete') ?>',
                                'data': {'attributeSetId':attributeSetId, 'attributeId':attributeId},
                                'dataType': 'json',
                                'showLoader': true
                            }).done(function (data) {
                                if (data.error) {
                                    alert({
                                        'title': '<?php echo __('Error') ?>',
                                        'content': data.message
                                    });
                                } else {
                                    getAjaxGrid(attributeSetId);
                                }

                                modal.closeModal(true);
                            });
                        }
                    }]
                });
            });

            /* Dynamic rows delete */
            gridWrapper.on('click', '#<?php echo $block->getGridName() ?>-table a.dynamic-delete-action', function (e) {
                e.preventDefault();
                $(this).parents('tr').remove();
            });

            /* Dynamic rows default options */
            gridWrapper.on('change', '#<?php echo $block->getGridName() ?>-table tr.dynamic-row select.madkting-attribute', function () {
                var self = $(this),
                    attributeId = self.val(),
                    rowId = self.parents('tr.dynamic-row').data('dynamicId');

                $.ajax({
                    'url': '<?php echo $block->getUrl('*/attributemapping/newrow') ?>',
                    'data': {'petition':'options', 'attributeId':attributeId, 'rowId':rowId},
                    'dataType': 'json',
                    'showLoader': true
                }).done(function (data) {
                    if (data.error) {
                        alert({
                            'title': '<?php echo __('Error') ?>',
                            'content': data.message
                        });
                    } else {
                        self.parents('tr').find('div.default-options-content').html(data.options);
                    }
                });
            });
        });
    });
</script>
